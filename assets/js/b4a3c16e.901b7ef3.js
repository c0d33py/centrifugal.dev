"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[5734],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>d});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(t),d=r,k=m["".concat(l,".").concat(d)]||m[d]||c[d]||o;return t?a.createElement(k,i(i({ref:n},u),{},{components:t})):a.createElement(k,i({ref:n},u))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=m;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},92964:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const o={id:"consumers",sidebar_label:"Async consumers",title:"Built-in API command async consumers"},i=void 0,s={unversionedId:"server/consumers",id:"server/consumers",title:"Built-in API command async consumers",description:"In server API chapter we've shown how to execute various Centrifugo server API commands (publish, broadcast, etc.) over HTTP or GRPC. In many cases you will call those APIs from your application business logic synchronously. But to deal with temporary network and availability issues, and achieve reliable execution of API commands upon changes in your primary application database you may want to use queuing techniques and call Centrifugo API asynchronously.",source:"@site/docs/server/consumers.md",sourceDirName:"server",slug:"/server/consumers",permalink:"/docs/server/consumers",draft:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/consumers.md",tags:[],version:"current",frontMatter:{id:"consumers",sidebar_label:"Async consumers",title:"Built-in API command async consumers"},sidebar:"Guides",previous:{title:"Engines and scalability",permalink:"/docs/server/engines"},next:{title:"History and recovery",permalink:"/docs/server/history_and_recovery"}},l={},p=[{value:"Supported consumers",id:"supported-consumers",level:2},{value:"How it works",id:"how-it-works",level:2},{value:"Common consumer options",id:"common-consumer-options",level:2},{value:"PostgreSQL outbox consumer",id:"postgresql-outbox-consumer",level:2},{value:"PostgreSQL consumer options",id:"postgresql-consumer-options",level:3},{value:"Kafka consumer",id:"kafka-consumer",level:2},{value:"Kafka consumer options",id:"kafka-consumer-options",level:3},{value:"Kafka TLS options",id:"kafka-tls-options",level:3}],u={toc:p};function c(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api"},"server API")," chapter we've shown how to execute various Centrifugo server API commands (publish, broadcast, etc.) over HTTP or GRPC. In many cases you will call those APIs from your application business logic synchronously. But to deal with temporary network and availability issues, and achieve reliable execution of API commands upon changes in your primary application database you may want to use queuing techniques and call Centrifugo API asynchronously."),(0,r.kt)("p",null,"Asynchronous delivery of real-time events upon changes in primary database may be done is several ways. Some companies use transactional outbox pattern, some using techniques like Kafka Connect with CDC (Change Data Capture) approach. The fact Centrifugo provides API allows users to implement any of those techniques and build worker which will send API commands to Centrifugo reliably."),(0,r.kt)("p",null,"But Centrifugo also provides some built-in asynchronous consumers to simplify the integration process."),(0,r.kt)("h2",{id:"supported-consumers"},"Supported consumers"),(0,r.kt)("p",null,"The following built-in async consumers are available at this point:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Consumer ",(0,r.kt)("a",{parentName:"li",href:"#postgresql-outbox-consumer"},"from PostgreSQL outbox table")," (since Centrifugo v5.2.0)"),(0,r.kt)("li",{parentName:"ul"},"Consumer ",(0,r.kt)("a",{parentName:"li",href:"#kafka-consumer"},"from Kafka topics")," (since Centrifugo v5.2.0)")),(0,r.kt)("h2",{id:"how-it-works"},"How it works"),(0,r.kt)("p",null,"Consumers expect to consume messages which represent Centrifugo ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api"},"server API commands"),". I.e. while in synchronous server API you are using HTTP or GRPC to send commands \u2013 with asynchronous consumers you are inserting API command to PostgreSQL outbox table, or delivering to Kafka topic \u2013 and it will be soon consumed and processed asynchronously by Centrifugo."),(0,r.kt)("p",null,"Async consumers only process commands which modify state \u2013 such as ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api#publish"},"publish"),", ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api#broadcast"},"broadcast"),", ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api#unsubscribe"},"unsubscribe"),", ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api#disconnect"},"disconnect"),", etc. Sending read commands for async execution simply does not make any sense and they will be ignored. Also, ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api#batch"},"batch")," method is not supported."),(0,r.kt)("p",null,"Centrifugo ",(0,r.kt)("strong",{parentName:"p"},"only supports JSON payloads for asynchronous commands coming to consumers for now"),". If you need binary format \u2013 reach out with your use case."),(0,r.kt)("p",null,"If Centrifugo encounters an error while processing consumed messages \u2013 then internal errors will be retried, all other errors logged on ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," level \u2013 and the message will be marked as processed. The processing logic for ",(0,r.kt)("a",{parentName:"p",href:"/docs/server/server_api#broadcast"},"broadcast")," API is special: if any of the publications to any channel from broadcast ",(0,r.kt)("inlineCode",{parentName:"p"},"channels")," array failed \u2013 then the entire broadcast command will be retried. To prevent duplicate messages being published during such retries \u2013 consider using ",(0,r.kt)("inlineCode",{parentName:"p"},"idempotency_key")," in the broadcast command."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Our ",(0,r.kt)("a",{parentName:"p",href:"/docs/tutorial/outbox_cdc"},"Chat/Messenger tutorial")," shows PostgreSQL outbox and Kafka consumer in action. It also shows techniques to avoid duplicate messages (idempotent publications) and deal with late message delivery (idempotent processing on client side). Whether you need those techniques \u2013 depends on the nature of app. Various real-time features may require different ways of sending real-time events. Both synchronous API calls and async calls have its own advantages and trade-offs. We also talk about this in ",(0,r.kt)("a",{parentName:"p",href:"/blog/2023/08/19/asynchronous-message-streaming-to-centrifugo-with-benthos"},"Asynchronous message streaming to Centrifugo with Benthos")," blog post.")),(0,r.kt)("h2",{id:"common-consumer-options"},"Common consumer options"),(0,r.kt)("p",null,"Consumers can be set in the configuration using ",(0,r.kt)("inlineCode",{parentName:"p"},"consumers")," array:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    ...\n    "consumers": [\n        {\n            "name": "xxx",\n            "type": "postgresql",\n            "postgresql": {...}\n        },\n        {\n            "name": "yyy",\n            "type": "kafka",\n            "kafka": {...}\n        },\n    ]\n}\n')),(0,r.kt)("p",null,"On top level each consumer object has the following fields:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"name")," - string (required), described name of consumer. Must be unique for each consumer and match the regex ",(0,r.kt)("inlineCode",{parentName:"li"},"^[a-zA-Z0-9_]{2,}")," - i.e. latin symbols, digits and underscores and be at least 2 symbols. This name will be used for logging purposes, metrics, also to override some options with environment variables. "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"type")," - string (required), type of consumer. At this point can be ",(0,r.kt)("inlineCode",{parentName:"li"},"postgresql")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"kafka")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"disabled")," - boolean (default: ",(0,r.kt)("inlineCode",{parentName:"li"},"false"),"), when set to ",(0,r.kt)("inlineCode",{parentName:"li"},"true")," allows disabling the consumer")),(0,r.kt)("p",null,"To provide ",(0,r.kt)("inlineCode",{parentName:"p"},"consumers")," over environment variable provide ",(0,r.kt)("inlineCode",{parentName:"p"},"CENTRIFUGO_CONSUMERS")," var with JSON array serialized to string. It's also possible to override some specific consumer options over environment variables \u2013 see below. "),(0,r.kt)("h2",{id:"postgresql-outbox-consumer"},"PostgreSQL outbox consumer"),(0,r.kt)("p",null,"Centrifugo can natively integrate with PostgreSQL table for ",(0,r.kt)("a",{parentName:"p",href:"https://microservices.io/patterns/data/transactional-outbox.html"},"Transactional outbox")," pattern. The table in PostgreSQL must have predefined format Centrifugo expects:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE IF NOT EXISTS centrifugo_outbox (\n    id BIGSERIAL PRIMARY KEY,\n    method text NOT NULL,\n    payload JSONB NOT NULL,\n    partition INTEGER NOT NULL default 0,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL\n);\n")),(0,r.kt)("p",null,"Then configure consumer of ",(0,r.kt)("inlineCode",{parentName:"p"},"postgresql")," type in Centrifugo config:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "consumers": [\n    {\n      "name": "my_postgresql_consumer",\n      "type": "postgresql",\n      "postgresql": {\n        "dsn": "postgresql://user:password@localhost:5432/db",\n        "outbox_table_name": "centrifugo_outbox",\n        "num_partitions": 1,\n        "partition_select_limit": 100,\n        "partition_poll_interval": "300ms"\n      }\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"Here is how you can insert row in outbox table to publish into Centrifugo channel:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-SQL"},'INSERT INTO centrifugo_outbox (method, payload, partition)\nVALUES (\'publish\', \'{"channel": "updates", "data": {"text": "Hello, world!"}}\', 0);\n')),(0,r.kt)("p",null,"Centrifugo supports LISTEN/NOTIFY mechanism of PostgreSQL to be notified about new data in the outbox table. To enable it you need first create a trigger in PostgreSQL:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE OR REPLACE FUNCTION centrifugo_notify_partition_change()\nRETURNS TRIGGER AS $$\nBEGIN\n    PERFORM pg_notify('centrifugo_partition_change', NEW.partition::text);\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE OR REPLACE TRIGGER centrifugo_notify_partition_trigger\nAFTER INSERT ON chat_outbox\nFOR EACH ROW\nEXECUTE FUNCTION centrifugo_notify_partition_change();\n")),(0,r.kt)("p",null,"And then update consumer config \u2013 add ",(0,r.kt)("inlineCode",{parentName:"p"},'"partition_notification_channel"')," option to it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "consumers": [\n    {\n      "name": "my_postgresql_consumer",\n      "type": "postgresql",\n      "postgresql": {\n        ...\n        "partition_notification_channel": "centrifugo_partition_change"\n      }\n    }\n  ]\n}\n')),(0,r.kt)("h3",{id:"postgresql-consumer-options"},"PostgreSQL consumer options"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dsn")," - string (required), DSN to PostgreSQL database, ex. ",(0,r.kt)("inlineCode",{parentName:"li"},'"postgresql://user:password@localhost:5432/db"'),". To override ",(0,r.kt)("inlineCode",{parentName:"li"},"dsn")," over environment variables use ",(0,r.kt)("inlineCode",{parentName:"li"},"CENTRIFUGO_CONSUMERS_POSTGRESQL_<CONSUMER_NAME>_DSN"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"outbox_table_name")," - string (required), the name of outbox table in selected database, ex. ",(0,r.kt)("inlineCode",{parentName:"li"},'"centrifugo_outbox"')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"num_partitions")," - integer (default: ",(0,r.kt)("inlineCode",{parentName:"li"},"1"),"), the number of partitions to use. Centrifugo keeps strict order of commands per-partition by default. This option provides a way to create concurrent consumers each consuming from different partition of outbox table. Note, that partition numbers in start with ",(0,r.kt)("inlineCode",{parentName:"li"},"0"),", so when using ",(0,r.kt)("inlineCode",{parentName:"li"},"1")," as ",(0,r.kt)("inlineCode",{parentName:"li"},"num_partitions")," insert data with ",(0,r.kt)("inlineCode",{parentName:"li"},"partition")," == ",(0,r.kt)("inlineCode",{parentName:"li"},"0")," to the outbox table."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"partition_select_limit")," - integer (default: ",(0,r.kt)("inlineCode",{parentName:"li"},"100"),") \u2013 max number of commands to select in one query to outbox table."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"partition_poll_interval")," - duration (default: ",(0,r.kt)("inlineCode",{parentName:"li"},'"300ms"'),") - polling interval for each partition"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"partition_notification_channel")," - string (default: ",(0,r.kt)("inlineCode",{parentName:"li"},'""'),") - optional name of LISTEN/NOTIFY channel to trigger consuming upon data added to outbox partition.")),(0,r.kt)("h2",{id:"kafka-consumer"},"Kafka consumer"),(0,r.kt)("p",null,"Another built-in consumer \u2013 is Kafka topics consumer. To configure Centrifugo to consume Kafka topic:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'  ...\n  "consumers": [\n    {\n      "name": "my_kafka_consumer",\n      "type": "kafka",\n      "kafka": {\n        "brokers": ["localhost:9092"],\n        "topics": ["postgres.public.chat_cdc"],\n        "consumer_group": "centrifugo"\n      }\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"Then simply put message in the following format to Kafka topic:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "method": "publish",\n  "payload": {\n    "channel": "mychannel",\n    "data": {}\n  }\n}\n')),(0,r.kt)("p",null,"\u2013 and it will be consumed by Centrifugo and reliably processed."),(0,r.kt)("h3",{id:"kafka-consumer-options"},"Kafka consumer options"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"brokers")," - array of strings (required), points Centrifugo to Kafka brokers. To override ",(0,r.kt)("inlineCode",{parentName:"li"},"brokers")," over environment variables use ",(0,r.kt)("inlineCode",{parentName:"li"},"CENTRIFUGO_CONSUMERS_KAFKA_<CONSUMER_NAME>_BROKERS")," \u2013 string with broker addresses separated by space."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"topics")," - array of string (required), tells which topics to consume"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"consumer_group")," - string (required), sets the name of consumer group to use"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"max_poll_records")," - integer (default: ",(0,r.kt)("inlineCode",{parentName:"li"},"100"),") - sets the maximum number of records to fetch from Kafka during a single poll operation."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sasl_mechanism")," - only ",(0,r.kt)("inlineCode",{parentName:"li"},'"plain"')," is now supported"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sasl_user")," - string, user for plain SASL auth. To override ",(0,r.kt)("inlineCode",{parentName:"li"},"sasl_user")," over environment variables use ",(0,r.kt)("inlineCode",{parentName:"li"},"CENTRIFUGO_CONSUMERS_KAFKA_<CONSUMER_NAME>_SASL_USER"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sasl_password")," - string, password for plain SASL auth. To override ",(0,r.kt)("inlineCode",{parentName:"li"},"sasl_password")," over environment variables use ",(0,r.kt)("inlineCode",{parentName:"li"},"CENTRIFUGO_CONSUMERS_KAFKA_<CONSUMER_NAME>_SASL_PASSWORD"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls")," - boolean (default: ",(0,r.kt)("inlineCode",{parentName:"li"},"false"),") - enables TLS, if ",(0,r.kt)("inlineCode",{parentName:"li"},"true")," \u2013 then all the ",(0,r.kt)("a",{parentName:"li",href:"#kafka-tls-options"},"TLS options")," may be additionally set.")),(0,r.kt)("h3",{id:"kafka-tls-options"},"Kafka TLS options"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_cert")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," representing the path on disk to the TLS certificate. This is typically used for the server certificate in TLS connections."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_key")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," representing the path on disk to the TLS key associated with the certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_cert_pem")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," containing the PEM (Privacy Enhanced Mail) encoded TLS certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_key_pem")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," containing the PEM encoded TLS key."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_root_ca")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," representing the path on disk to the root CA certificate. This is used to verify the server certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_root_ca_pem")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," containing the PEM encoded root CA certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_client_ca")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," representing the path on disk to the client CA certificate. This is used in mutual TLS"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_client_ca_pem")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," containing the PEM encoded client CA certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"tls_insecure_skip_verify")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"boolean")," indicating whether to skip verifying the server's certificate chain and host name. If ",(0,r.kt)("inlineCode",{parentName:"li"},"true"),", TLS accepts any certificate presented by the server and any host name in that certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"server_name")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"string")," specifying the server name to use for server certificate verification if ",(0,r.kt)("inlineCode",{parentName:"li"},"tls_insecure_skip_verify")," is false. This is also used in the client's SNI (Server Name Indication) extension in TLS handshake.")))}c.isMDXComponent=!0}}]);